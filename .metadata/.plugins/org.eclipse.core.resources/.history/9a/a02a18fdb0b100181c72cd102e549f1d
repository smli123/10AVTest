package com.sherman.smartplugex.ui.util;

import com.sherman.smartlock.R;

import android.content.Context;
import android.content.SharedPreferences;
import android.os.AsyncTask;
import android.preference.PreferenceManager;
import android.util.AttributeSet;
import android.view.LayoutInflater;
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewConfiguration;
import android.view.animation.RotateAnimation;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.TextView;

public class RefreshableView extends LinearLayout implements View.OnTouchListener {  
	  
    /** 
     * ï¿½ï¿½ï¿½ï¿½×´Ì¬ 
     */  
    public static final int STATUS_PULL_TO_REFRESH = 0;  
  
    /** 
     * ï¿½Í·ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬ 
     */  
    public static final int STATUS_RELEASE_TO_REFRESH = 1;  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬ 
     */  
    public static final int STATUS_REFRESHING = 2;  
  
    /** 
     * Ë¢ï¿½ï¿½ï¿½ï¿½É»ï¿½Î´Ë¢ï¿½ï¿½×´Ì? 
     */  
    public static final int STATUS_REFRESH_FINISHED = 3;  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½Ø¹ï¿½ï¿½ï¿½ï¿½Ù¶ï¿½ 
     */  
    public static final int SCROLL_SPEED = -20;  
  
    /** 
     * Ò»ï¿½ï¿½ï¿½ÓµÄºï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Ï´ÎµÄ¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ 
     */  
    public static final long ONE_MINUTE = 60 * 1000;  
  
    /** 
     * Ò»Ð¡Ê±ï¿½Äºï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Ï´ÎµÄ¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ 
     */  
    public static final long ONE_HOUR = 60 * ONE_MINUTE;  
  
    /** 
     * Ò»ï¿½ï¿½Äºï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Ï´ÎµÄ¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿? 
     */  
    public static final long ONE_DAY = 24 * ONE_HOUR;  
  
    /** 
     * Ò»ï¿½ÂµÄºï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Ï´ÎµÄ¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ 
     */  
    public static final long ONE_MONTH = 30 * ONE_DAY;  
  
    /** 
     * Ò»ï¿½ï¿½Äºï¿½ï¿½ï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Ï´ÎµÄ¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿? 
     */  
    public static final long ONE_YEAR = 12 * ONE_MONTH;  
  
    /** 
     * SharedPreferences 
     */  
    private static final String UPDATED_AT = "updated_at";  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ÂµÄ»Øµï¿½ï¿½Ó¿ï¿½ 
     */  
    private PullToRefreshListener mListener;  
  
    /** 
     * ï¿½ï¿½ï¿½Ú´æ´¢ï¿½Ï´Î¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ 
     */  
    private SharedPreferences preferences;  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½View 
     */  
    private View header;  
  
    /** 
     * ï¿½ï¿½ÒªÈ¥ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Âµï¿½ListView 
     */  
    private ListView listView;  
  
    /** 
     * Ë¢ï¿½ï¿½Ê±ï¿½ï¿½Ê¾ï¿½Ä½ï¿½ï¿½ï¿½ï¿? 
     */  
    private ProgressBar progressBar;  
  
    /** 
     * Ö¸Ê¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ÅµÄ¼ï¿½Í· 
     */  
    private ImageView arrow;  
  
    /** 
     * Ö¸Ê¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·Åµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
     */  
    private TextView description;  
  
    /** 
     * ï¿½Ï´Î¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿? 
     */  
    private TextView updateAt;  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Í·ï¿½Ä²ï¿½ï¿½Ö²ï¿½ï¿½ï¿½ 
     */  
    private MarginLayoutParams headerLayoutParams;  
  
    /** 
     * ï¿½Ï´Î¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½Äºï¿½ï¿½ï¿½Ö? 
     */  
    private long lastUpdateTime;  
  
    /** 
     * Îªï¿½Ë·ï¿½Ö¹ï¿½ï¿½Í¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½ï¿½ï¿½ï¿½Ï´Î¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½Ï»ï¿½ï¿½ï¿½ï¿½Ð³ï¿½Í»ï¿½ï¿½Ê¹ï¿½ï¿½idï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿? 
     */  
    private int mId = -1;  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Í·ï¿½Ä¸ß¶ï¿½ 
     */  
    private int hideHeaderHeight;  
  
    /** 
     * ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½Ê²Ã´×´Ì¬ï¿½ï¿½ï¿½ï¿½Ñ¡Öµï¿½ï¿½STATUS_PULL_TO_REFRESH, STATUS_RELEASE_TO_REFRESH, 
     * STATUS_REFRESHING ï¿½ï¿½ STATUS_REFRESH_FINISHED 
     */  
    private int currentStatus = STATUS_REFRESH_FINISHED;;  
  
    /** 
     * ï¿½ï¿½Â¼ï¿½ï¿½Ò»ï¿½Îµï¿½×´Ì¬ï¿½ï¿½Ê²Ã´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø¸ï¿½ï¿½ï¿½ï¿½ï¿? 
     */  
    private int lastStatus = currentStatus;  
  
    /** 
     * ï¿½ï¿½Ö¸ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½Ä»ï¿½ï¿½ï¿½ï¿½ï¿? 
     */  
    private float yDown;  
  
    /** 
     * ï¿½Ú±ï¿½ï¿½Ð¶ï¿½Îªï¿½ï¿½ï¿½ï¿½Ö®Ç°ï¿½Ã»ï¿½ï¿½ï¿½Ö¸ï¿½ï¿½ï¿½ï¿½ï¿½Æ¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Öµï¿½ï¿? 
     */  
    private int touchSlop;  
  
    /** 
     * ï¿½Ç·ï¿½ï¿½Ñ¼ï¿½ï¿½Ø¹ï¿½Ò»ï¿½ï¿½layoutï¿½ï¿½ï¿½ï¿½ï¿½ï¿½onLayoutï¿½ÐµÄ³ï¿½Ê¼ï¿½ï¿½Ö»ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿? 
     */  
    private boolean loadOnce;  
  
    /** 
     * ï¿½ï¿½Ç°ï¿½Ç·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö»ï¿½ï¿½ListViewï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿? 
     */  
    private boolean ableToPull;  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Â¿Ø¼ï¿½ï¿½Ä¹ï¿½ï¿½ìº¯ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½Ì¬ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½Ä²ï¿½ï¿½Ö¡ï¿½ 
     *  
     * @param context 
     * @param attrs 
     */  
    public RefreshableView(Context context, AttributeSet attrs) {  
        super(context, attrs);  
        preferences = PreferenceManager.getDefaultSharedPreferences(context);  
        header = LayoutInflater.from(context).inflate(R.layout.view_pull_to_update, null, true);  
        progressBar = (ProgressBar) header.findViewById(R.id.progress_bar);  
        arrow = (ImageView) header.findViewById(R.id.arrow);  
        description = (TextView) header.findViewById(R.id.description);  
        updateAt = (TextView) header.findViewById(R.id.updated_at);  
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();  
        refreshUpdatedAtValue();  
        setOrientation(VERTICAL);  
        addView(header, 0);  
    }  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Ò»Ð©ï¿½Ø¼ï¿½ï¿½ÔµÄ³ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ç£ºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½ï¿½Æ«ï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø£ï¿½ï¿½ï¿½ListView×¢ï¿½ï¿½touchï¿½Â¼ï¿½ï¿½ï¿½ 
     */  
    @Override  
    protected void onLayout(boolean changed, int l, int t, int r, int b) {  
        super.onLayout(changed, l, t, r, b);  
        if (changed && !loadOnce) {  
            hideHeaderHeight = -header.getHeight();  
            headerLayoutParams = (MarginLayoutParams) header.getLayoutParams();  
            headerLayoutParams.topMargin = hideHeaderHeight;  
            listView = (ListView) getChildAt(1);  
            listView.setOnTouchListener(this);  
            loadOnce = true;  
        }  
    }  
  
    /** 
     * ï¿½ï¿½ListViewï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½Ã£ï¿½ï¿½ï¿½ï¿½Ð´ï¿½ï¿½ï¿½ï¿½Ë¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ÂµÄ¾ï¿½ï¿½ï¿½ï¿½ß¼ï¿½ï¿½ï¿½ 
     */  
    @Override  
    public boolean onTouch(View v, MotionEvent event) {  
        setIsAbleToPull(event);  
        if (ableToPull) {  
            switch (event.getAction()) {  
            case MotionEvent.ACTION_DOWN:  
                yDown = event.getRawY();  
                break;  
            case MotionEvent.ACTION_MOVE:  
                float yMove = event.getRawY();  
                int distance = (int) (yMove - yDown);  
                // ï¿½ï¿½ï¿½ï¿½ï¿½Ö¸ï¿½ï¿½ï¿½Â»ï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½ï¿½È«ï¿½ï¿½ï¿½ØµÄ£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â¼ï¿?  
                if (distance <= 0 && headerLayoutParams.topMargin <= hideHeaderHeight) {  
                    return false;  
                }  
                if (distance < touchSlop) {  
                    return false;  
                }  
                if (currentStatus != STATUS_REFRESHING) {  
                    if (headerLayoutParams.topMargin > 0) {  
                        currentStatus = STATUS_RELEASE_TO_REFRESH;  
                    } else {  
                        currentStatus = STATUS_PULL_TO_REFRESH;  
                    }  
                    // Í¨ï¿½ï¿½Æ«ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½topMarginÖµï¿½ï¿½ï¿½ï¿½Êµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð§ï¿½ï¿½  
                    headerLayoutParams.topMargin = (distance / 2) + hideHeaderHeight;  
                    header.setLayoutParams(headerLayoutParams);  
                }  
                break;  
            case MotionEvent.ACTION_UP:  
            default:  
                if (currentStatus == STATUS_RELEASE_TO_REFRESH) {  
                    // ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½È¥ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Âµï¿½ï¿½ï¿½ï¿½ï¿?  
                    new RefreshingTask().execute();  
                } else if (currentStatus == STATUS_PULL_TO_REFRESH) {  
                    // ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½È¥ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?  
                    new HideHeaderTask().execute();  
                }  
                break;  
            }  
            // Ê±ï¿½Ì¼ÇµÃ¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½Ðµï¿½ï¿½ï¿½Ï¢  
            if (currentStatus == STATUS_PULL_TO_REFRESH  
                    || currentStatus == STATUS_RELEASE_TO_REFRESH) {  
                updateHeaderView();  
                // ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½×´Ì¬ï¿½ï¿½Òªï¿½ï¿½ListViewÊ§È¥ï¿½ï¿½ï¿½ã£¬ï¿½ï¿½ï¿½ò±»µï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½Ò»Ö±ï¿½ï¿½ï¿½ï¿½Ñ¡ï¿½ï¿½×´Ì¬  
                listView.setPressed(false);  
                listView.setFocusable(false);  
                listView.setFocusableInTouchMode(false);  
                lastStatus = currentStatus;  
                // ï¿½ï¿½Ç°ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½×´Ì¬ï¿½ï¿½Í¨ï¿½ï¿½ï¿½trueï¿½ï¿½ï¿½Îµï¿½ListViewï¿½Ä¹ï¿½ï¿½ï¿½ï¿½Â¼ï¿½  
                return true;  
            }  
        }  
        return false;  
    }  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Â¿Ø¼ï¿½×¢ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
     *  
     * @param listener 
     *            ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Êµï¿½Ö¡ï¿½ 
     * @param id 
     *            Îªï¿½Ë·ï¿½Ö¹ï¿½ï¿½Í¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½ï¿½ï¿½ï¿½Ï´Î¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½Ï»ï¿½ï¿½ï¿½ï¿½Ð³ï¿½Í»ï¿½ï¿? ï¿½ë²»Í¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½×¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Â¼ï¿½ï¿½ï¿½ï¿½ï¿½Ê±Ò»ï¿½ï¿½Òªï¿½ï¿½ï¿½ë²»Í¬ï¿½ï¿½idï¿½ï¿½ 
     */  
    public void setOnRefreshListener(PullToRefreshListener listener, int id) {  
        mListener = listener;  
        mId = id;  
    }  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½ï¿½Ðµï¿½Ë¢ï¿½ï¿½ï¿½ß¼ï¿½ï¿½ï¿½Éºó£¬¼ï¿½Â¼ï¿½ï¿½ï¿½ï¿½Ò»ï¿½Â£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ListViewï¿½ï¿½Ò»Ö±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½×´Ì¬ï¿½ï¿½ 
     */  
    public void finishRefreshing() {  
        currentStatus = STATUS_REFRESH_FINISHED;  
        preferences.edit().putLong(UPDATED_AT + mId, System.currentTimeMillis()).commit();  
        new HideHeaderTask().execute();  
    }  
  
    /** 
     * ï¿½ï¿½Ýµï¿½Ç°ListViewï¿½Ä¹ï¿½ï¿½ï¿½×´Ì¬ï¿½ï¿½ï¿½è¶¨ {@link #ableToPull} 
     * ï¿½ï¿½Öµï¿½ï¿½Ã¿ï¿½Î¶ï¿½ï¿½ï¿½Òªï¿½ï¿½onTouchï¿½Ðµï¿½Ò»ï¿½ï¿½Ö´ï¿½Ð£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶Ï³ï¿½ï¿½ï¿½Ç°Ó¦ï¿½ï¿½ï¿½Ç¹ï¿½ï¿½ï¿½ListViewï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ó¦ï¿½Ã½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
     *  
     * @param event 
     */  
    private void setIsAbleToPull(MotionEvent event) {  
        View firstChild = listView.getChildAt(0);  
        if (firstChild != null) {  
            int firstVisiblePos = listView.getFirstVisiblePosition();  
            if (firstVisiblePos == 0 && firstChild.getTop() == 0) {  
                if (!ableToPull) {  
                    yDown = event.getRawY();  
                }  
                // ï¿½ï¿½ï¿½ï¿½×¸ï¿½Ôªï¿½Øµï¿½ï¿½Ï±ï¿½Ôµï¿½ï¿½ï¿½ï¿½ï¿½ë¸¸ï¿½ï¿½ï¿½ï¿½ÖµÎ?0ï¿½ï¿½ï¿½ï¿½Ëµï¿½ï¿½ListViewï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½î¶¥ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±Ó¦ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½  
                ableToPull = true;  
            } else {  
                if (headerLayoutParams.topMargin != hideHeaderHeight) {  
                    headerLayoutParams.topMargin = hideHeaderHeight;  
                    header.setLayoutParams(headerLayoutParams);  
                }  
                ableToPull = false;  
            }  
        } else {  
            // ï¿½ï¿½ï¿½ListViewï¿½ï¿½Ã»ï¿½ï¿½Ôªï¿½Ø£ï¿½Ò²Ó¦ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½  
            ableToPull = true;  
        }  
    }  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½Ðµï¿½ï¿½ï¿½Ï¢ï¿½ï¿½ 
     */  
    private void updateHeaderView() {  
        if (lastStatus != currentStatus) {  
            if (currentStatus == STATUS_PULL_TO_REFRESH) {  
                description.setText(getResources().getString(R.string.pull_to_refresh));  
                arrow.setVisibility(View.VISIBLE);  
                progressBar.setVisibility(View.GONE);  
                rotateArrow();  
            } else if (currentStatus == STATUS_RELEASE_TO_REFRESH) {  
                description.setText(getResources().getString(R.string.release_to_refresh));  
                arrow.setVisibility(View.VISIBLE);  
                progressBar.setVisibility(View.GONE);  
                rotateArrow();  
            } else if (currentStatus == STATUS_REFRESHING) {  
                description.setText(getResources().getString(R.string.refreshing));  
                progressBar.setVisibility(View.VISIBLE);  
                arrow.clearAnimation();  
                arrow.setVisibility(View.GONE);  
            }  
            refreshUpdatedAtValue();  
        }  
    }  
  
    /** 
     * ï¿½ï¿½Ýµï¿½Ç°ï¿½ï¿½×´Ì¬ï¿½ï¿½ï¿½ï¿½×ªï¿½ï¿½Í·ï¿½ï¿? 
     */  
    private void rotateArrow() {  
        float pivotX = arrow.getWidth() / 2f;  
        float pivotY = arrow.getHeight() / 2f;  
        float fromDegrees = 0f;  
        float toDegrees = 0f;  
        if (currentStatus == STATUS_PULL_TO_REFRESH) {  
            fromDegrees = 180f;  
            toDegrees = 360f;  
        } else if (currentStatus == STATUS_RELEASE_TO_REFRESH) {  
            fromDegrees = 0f;  
            toDegrees = 180f;  
        }  
        RotateAnimation animation = new RotateAnimation(fromDegrees, toDegrees, pivotX, pivotY);  
        animation.setDuration(100);  
        animation.setFillAfter(true);  
        arrow.startAnimation(animation);  
    }  
  
    /** 
     * Ë¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½Ï´Î¸ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿? 
     */  
    private void refreshUpdatedAtValue() {  
        lastUpdateTime = preferences.getLong(UPDATED_AT + mId, -1);  
        long currentTime = System.currentTimeMillis();  
        long timePassed = currentTime - lastUpdateTime;  
        long timeIntoFormat;  
        String updateAtValue;  
        if (lastUpdateTime == -1) {  
            updateAtValue = getResources().getString(R.string.not_updated_yet);  
        } else if (timePassed < 0) {  
            updateAtValue = getResources().getString(R.string.time_error);  
        } else if (timePassed < ONE_MINUTE) {  
            updateAtValue = getResources().getString(R.string.updated_just_now);  
        } else if (timePassed < ONE_HOUR) {  
            timeIntoFormat = timePassed / ONE_MINUTE;  
            String value = timeIntoFormat + getResources().getString(R.string.update_minute);  
            updateAtValue = String.format(getResources().getString(R.string.updated_at), value);  
        } else if (timePassed < ONE_DAY) {  
            timeIntoFormat = timePassed / ONE_HOUR;  
            String value = timeIntoFormat + getResources().getString(R.string.update_hour);  
            updateAtValue = String.format(getResources().getString(R.string.updated_at), value);  
        } else if (timePassed < ONE_MONTH) {  
            timeIntoFormat = timePassed / ONE_DAY;  
            String value = timeIntoFormat + getResources().getString(R.string.update_day);  
            updateAtValue = String.format(getResources().getString(R.string.updated_at), value);  
        } else if (timePassed < ONE_YEAR) {  
            timeIntoFormat = timePassed / ONE_MONTH;  
            String value = timeIntoFormat + getResources().getString(R.string.update_month);  
            updateAtValue = String.format(getResources().getString(R.string.updated_at), value);  
        } else {  
            timeIntoFormat = timePassed / ONE_YEAR;  
            String value = timeIntoFormat + getResources().getString(R.string.update_year);  
            updateAtValue = String.format(getResources().getString(R.string.updated_at), value);  
        }  
        updateAt.setText(updateAtValue);  
    }  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Âµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ú´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð»ï¿½È¥ï¿½Øµï¿½×¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Â¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿? 
     *  
     * @author guolin 
     */  
    class RefreshingTask extends AsyncTask<Void, Integer, Void> {  
  
        @Override  
        protected Void doInBackground(Void... params) {  
            int topMargin = headerLayoutParams.topMargin;  
            while (true) {  
                topMargin = topMargin + SCROLL_SPEED;  
                if (topMargin <= 0) {  
                    topMargin = 0;  
                    break;  
                }  
                publishProgress(topMargin);  
                sleep(10);  
            }  
            currentStatus = STATUS_REFRESHING;  
            publishProgress(0);  
            if (mListener != null) {  
                mListener.onRefresh();  
            }  
            return null;  
        }  
  
        @Override  
        protected void onProgressUpdate(Integer... topMargin) {  
            updateHeaderView();  
            headerLayoutParams.topMargin = topMargin[0];  
            header.setLayoutParams(headerLayoutParams);  
        }  
  
    }  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½ï¿½ï¿½ñ£¬µï¿½Î´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½Â»ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½ï¿½ï¿½Éºó£¬´ï¿½ï¿½ï¿½ï¿½ñ½«»ï¿½Ê¹ï¿½ï¿½ï¿½ï¿½Í·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø¡ï¿? 
     *  
     * @author guolin 
     */  
    class HideHeaderTask extends AsyncTask<Void, Integer, Integer> {  
  
        @Override  
        protected Integer doInBackground(Void... params) {  
            int topMargin = headerLayoutParams.topMargin;  
            while (true) {  
                topMargin = topMargin + SCROLL_SPEED;  
                if (topMargin <= hideHeaderHeight) {  
                    topMargin = hideHeaderHeight;  
                    break;  
                }  
                publishProgress(topMargin);  
                sleep(10);  
            }  
            return topMargin;  
        }  
  
        @Override  
        protected void onProgressUpdate(Integer... topMargin) {  
            headerLayoutParams.topMargin = topMargin[0];  
            header.setLayoutParams(headerLayoutParams);  
        }  
  
        @Override  
        protected void onPostExecute(Integer topMargin) {  
            headerLayoutParams.topMargin = topMargin;  
            header.setLayoutParams(headerLayoutParams);  
            currentStatus = STATUS_REFRESH_FINISHED;  
        }  
    }  
  
    /** 
     * Ê¹ï¿½ï¿½Ç°ï¿½ß³ï¿½Ë¯ï¿½ï¿½Ö¸ï¿½ï¿½ï¿½Äºï¿½ï¿½ï¿½ï¿½ï¿½ 
     *  
     * @param time 
     *            Ö¸ï¿½ï¿½ï¿½ï¿½Ç°ï¿½ß³ï¿½Ë¯ï¿½ß¶ï¿½Ã£ï¿½ï¿½Ôºï¿½ï¿½ï¿½Îªï¿½ï¿½Î? 
     */  
    private void sleep(int time) {  
        try {  
            Thread.sleep(time);  
        } catch (InterruptedException e) {  
            e.printStackTrace();  
        }  
    }  
  
    /** 
     * ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ÂµÄ¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ÂµÄµØ·ï¿½Ó¦ï¿½ï¿½×¢ï¿½ï¿½Ë¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½È¡Ë¢ï¿½Â»Øµï¿½ï¿½ï¿? 
     *  
     * @author guolin 
     */  
    public interface PullToRefreshListener {  
  
        /** 
         * Ë¢ï¿½ï¿½Ê±ï¿½ï¿½È¥ï¿½Øµï¿½ï¿½Ë·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ú·ï¿½ï¿½ï¿½ï¿½Ú±ï¿½Ð´ï¿½ï¿½ï¿½ï¿½ï¿½Ë¢ï¿½ï¿½ï¿½ß¼ï¿½ï¿½ï¿½×¢ï¿½ï¿½Ë·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ß³ï¿½ï¿½Ðµï¿½ï¿½ÃµÄ£ï¿½ ï¿½ï¿½ï¿½ï¿½Ô²ï¿½ï¿½ï¿½ï¿½?ï¿½ß³ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ðºï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 
         */  
        void onRefresh();  
  
    }  
  
}  