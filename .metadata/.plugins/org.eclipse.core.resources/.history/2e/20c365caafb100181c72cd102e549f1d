package com.sherman.smartplugex.ui.smartlockex;

import java.util.ArrayList;
import java.util.List;
import java.util.Timer;

//import com.iflytek.cloud.SpeechConstant;
//import com.iflytek.cloud.SpeechUtility;
import com.sherman.smartlock.processhandler.SmartLockEventHandler;
import com.sherman.smartlock.ui.common.PubDefine;
import com.sherman.smartlock.ui.common.PubFunc;
import com.sherman.smartlock.ui.login.LoginActivity;
import com.sherman.smartlock.ui.wheelutils.MyAlertDialog;
import com.sherman.smartlock.util.AppTimeoutTask;
import com.sherman.smartlock.util.CrashHandler;
import com.sherman.smartlock.R;

import android.app.Activity;
import android.app.Application;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.media.MediaPlayer;
import android.os.Environment;
import android.speech.tts.TextToSpeech;
import android.view.View;

public class SmartPlugApplication extends Application {
    private static SmartLockApplication sMe;
    private static boolean mLogined = false;
    
    private static Timer mCheckTimer = null;
    private static AppTimeoutTask mTimeoutTask = null;
    
    public static int mCounter = 0;
    private final static long TIMEOUT = 3600000;  //60åˆ†é’Ÿï¼Œè‹¥60åˆ†é’Ÿå†…æ²¡æœ‰æ“ä½œï¼ŒAPPä¾¿è‡ªåŠ¨é??å‡ºã??
    
    private static boolean mFirstUse = true;
    
    private List<Activity> mList = new ArrayList<Activity>(); 
    
	private SharedPreferences mSharedPreferences;
	private SharedPreferences.Editor editor;
    
    @Override
    public void onCreate() {
    	super.onCreate();
    	
    	sMe = this;
    	mCheckTimer = new Timer();
    	mFirstUse = false;
    	CrashHandler.getInstance().init(getApplicationContext());  
    	SmartLockEventHandler.getInstance().init();
    	
    	mSharedPreferences = getSharedPreferences("SmartPlug", Activity.MODE_PRIVATE);
		loadAPPConfig();
		
//		// å¯åŠ¨è¯­éŸ³æ§åˆ¶
//		// åº”ç”¨ç¨‹åºå…¥å£å¤„è°ƒç”?,é¿å…æ‰‹æœºå†…å­˜è¿‡å°ï¼Œæ€æ­»åå°è¿›ç¨?,é€ æˆSpeechUtilityå¯¹è±¡ä¸ºnull
//		// è®¾ç½®ä½ ç”³è¯·çš„åº”ç”¨appid
//		StringBuffer param = new StringBuffer();
//		param.append("appid="+getString(R.string.app_id));
//		param.append(",");
//		// è®¾ç½®ä½¿ç”¨v5+
//		param.append(SpeechConstant.ENGINE_MODE+"="+SpeechConstant.MODE_MSC);
//		SpeechUtility.createUtility(SmartPlugApplication.this, param.toString());
		
	}
	
	private void loadAPPConfig() {
		PubDefine.THINGZDO_HOST_NAME = mSharedPreferences.getString("serverip", PubDefine.SERVERIP_HANGZHOU);

		// DEBUG using Shenzhen server ip.
//		PubDefine.THINGZDO_HOST_NAME = PubDefine.SERVERIP_SHENZHEN;
	}
    
    @Override
    public void onTerminate() {
    	// TODO Auto-generated method stub
    	super.onTerminate();
    }
    
    public static SmartLockApplication getInstance() {
    	return sMe;
    }
    
	public static Context getContext(){
		return getInstance().getApplicationContext();
	}    
    
    public static boolean isLogined() {
    	return mLogined; 
    }
    
    public static void setLogined(boolean isLogined) {
    	mLogined = isLogined; 
    	if (mLogined) {
    		mCounter = 0;
    	}
    }
    
    public static void setFirstUse(boolean isFirstUse) {
    	mFirstUse = isFirstUse;	
    }
    
    public static boolean getFirstUse() {
    	return mFirstUse;
    }
    
    // add Activity  
    public void addActivity(Activity activity) { 
        mList.add(activity); 
    } 
    
    public void exit() { 
        try { 
            for (Activity activity : mList) { 
                if (activity != null && !(activity instanceof LoginActivity))
                    activity.finish(); 
            } 
        } catch (Exception e) { 
            e.printStackTrace(); 
        } finally { 
            System.exit(0); 
        } 
    } 
    
    public void finishSmartPlugActivity() {
        try { 
            for (Activity activity : mList) { 
                if ((activity instanceof SmartPlugActivity)) {
                    activity.finish();
                    break;
                }
                
            } 
        } catch (Exception e) { 
            e.printStackTrace(); 
        } finally { 
            System.exit(0); 
        }     	
    }
    
    
    public void onLowMemory() { 
        super.onLowMemory();     
        System.gc(); 
    }   
    
    public static void resetTask() {
    	if (null != mCheckTimer) {
    		mCheckTimer.cancel();
    	}
    	if (null != mTimeoutTask) {
    		mTimeoutTask.cancel();
    	}
    	
    	mCheckTimer = null;
    	mTimeoutTask = null;
    	mCheckTimer = new Timer();
    	mTimeoutTask = new AppTimeoutTask();
    	mCheckTimer.schedule(mTimeoutTask, TIMEOUT, TIMEOUT);
    }
    
    public static void closeTask() {
    	if (null != mCheckTimer) {
    		mCheckTimer.cancel();
    	}
    	if (null != mTimeoutTask) {
    		mTimeoutTask.cancel();
    	}
    	
    	mCheckTimer = null;
    	mTimeoutTask = null;
    }
   
}
