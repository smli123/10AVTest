package com.sherman.smartplugex.ui.util;

import android.content.Context;
import android.graphics.Color;
import android.graphics.drawable.ColorDrawable;
import android.graphics.drawable.Drawable;
import android.util.AttributeSet;
import android.view.MotionEvent;
import android.view.View;
import android.view.inputmethod.InputMethodManager;
import android.widget.AdapterView;
import android.widget.BaseAdapter;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.PopupWindow;

import com.sherman.smartlock.ui.common.PubDefine;
import com.sherman.smartlock.R;

public class DropEditText extends EditText
		implements
			AdapterView.OnItemClickListener,
			PopupWindow.OnDismissListener {

	private Drawable mDrawable; // æ˜¾ç¤ºçš„å›¾
	private PopupWindow mPopupWindow; // ç‚¹å‡»å›¾ç‰‡å¼¹å‡ºçš„popWindowå¯¹è±¡
	private ListView mPopListView; // popWindowçš„å¸ƒå±?
	private int mDropDrawableResId; // ä¸‹æ‹‰å›¾æ ‡
	private int mRiseDrawableResID; // ä¸Šæ‹‰å›¾æ ‡

	public DropEditText(Context context) {
		this(context, null);
	}

	public DropEditText(Context context, AttributeSet attrs) {
		super(context, attrs);
		init(context);
	}

	public DropEditText(Context context, AttributeSet attrs, int defStyle) {
		super(context, attrs, defStyle);
		init(context);
	}

	private void init(Context context) {
		mPopListView = new ListView(context);
		mDropDrawableResId = R.drawable.drop; // è®¾ç½®ä¸‹æ‹‰å›¾æ ‡
		mRiseDrawableResID = R.drawable.close; // è®¾ç½®ä¸Šæ‹‰å›¾æ ‡
		showDropDrawable(); // é»˜è®¤æ˜¾ç¤ºä¸‹æ‹‰å›¾æ ‡
		mPopListView.setOnItemClickListener(this);
	}

	/**
	 * æˆ‘ä»¬æ— æ³•ç›´æ¥ç»™EditTextè®¾ç½®ç‚¹å‡»äº‹ä»¶ï¼Œåªèƒ½é?šè¿‡æŒ‰ä¸‹çš„ä½ç½®æ¥æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶ å½“æˆ‘ä»¬æŒ‰ä¸‹çš„ä½ç½®åœ¨å›¾æ ‡åŒ…æ‹¬å›¾æ ‡åˆ°æ§ä»¶å³è¾¹çš„é—´è·èŒƒå›´å†…å‡ç®—æœ‰æ•ˆ
	 */
	@Override
	public boolean onTouchEvent(MotionEvent event) {
		if (event.getAction() == MotionEvent.ACTION_UP) {
			if (getCompoundDrawables()[2] != null) {
				int start = getWidth() - getTotalPaddingRight()
						+ getPaddingRight(); // èµ·å§‹ä½ç½®
				int end = getWidth(); // ç»“æŸä½ç½®
				boolean available = (event.getX() > start)
						&& (event.getX() < end);
				if (available) {
					closeSoftInput();
					showPopWindow();
					return true;
				}
			}
		}
		return super.onTouchEvent(event);
	}

	@Override
	protected void onLayout(boolean changed, int left, int top, int right,
			int bottom) {
		super.onLayout(changed, left, top, right, bottom);
		if (changed) {
			mPopupWindow = new PopupWindow(mPopListView, getWidth(),
					LinearLayout.LayoutParams.WRAP_CONTENT);
			mPopupWindow.setBackgroundDrawable(new ColorDrawable(Color.WHITE)); // è®¾ç½®popWindowèƒŒæ™¯é¢œè‰²
			mPopupWindow.setFocusable(true); // è®©popWindowè·å–ç„¦ç‚¹
			mPopupWindow.setOnDismissListener(this);
		}
	}

	private void showPopWindow() {
		mPopupWindow.showAsDropDown(this, 0, 5);
		showRiseDrawable();
	}

	private void showDropDrawable() {
		mDrawable = getResources().getDrawable(mDropDrawableResId);
		if (PubDefine.RELEASE_VERSION == false) { // DEBUG
			mDrawable.setBounds(0, 0, mDrawable.getIntrinsicWidth(),
					mDrawable.getIntrinsicHeight());
		} else {
			mDrawable.setBounds(0, 0, 0, 0);
		}
		setCompoundDrawables(getCompoundDrawables()[0],
				getCompoundDrawables()[1], mDrawable, getCompoundDrawables()[3]);
	}

	private void showRiseDrawable() {
		mDrawable = getResources().getDrawable(mRiseDrawableResID);
		if (PubDefine.RELEASE_VERSION == false) { // DEBUG
			mDrawable.setBounds(0, 0, mDrawable.getIntrinsicWidth(),
					mDrawable.getIntrinsicHeight());
		} else {
			mDrawable.setBounds(0, 0, 0, 0);
		}
		setCompoundDrawables(getCompoundDrawables()[0],
				getCompoundDrawables()[1], mDrawable, getCompoundDrawables()[3]);
	}

	public void setAdapter(BaseAdapter adapter) {
		mPopListView.setAdapter(adapter);
	}

	private void closeSoftInput() {
		InputMethodManager imm = (InputMethodManager) getContext()
				.getSystemService(Context.INPUT_METHOD_SERVICE);
		imm.hideSoftInputFromWindow(this.getWindowToken(), 0);
	}

	@Override
	public void onItemClick(AdapterView<?> parent, View view, int position,
			long id) {
		this.setText(mPopListView.getAdapter().getItem(position).toString()); // å¯èƒ½éœ?è¦ä½ é‡å†™itemçš„toStringæ–¹æ³•
		mPopupWindow.dismiss();
	}

	@Override
	public void onDismiss() {
		showDropDrawable(); // å½“popWindowæ¶ˆå¤±æ—¶æ˜¾ç¤ºä¸‹æ‹‰å›¾æ ?
	}
}
