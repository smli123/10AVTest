package com.lishimin.robotcontroller;

import java.io.IOException;
import java.net.DatagramPacket;
import java.net.InetAddress;
import java.net.UnknownHostException;

import com.thingzdo.internet.AsyncResult;
import com.thingzdo.internet.UDPReceiver;
import com.thingzdo.ui.common.PubDefine;
import com.thingzdo.ui.common.PubFunc;
import com.thingzdo.ui.smartplug.AppServerReposeDefine;

import android.app.Activity;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.RelativeLayout;


public class MainActivity extends Activity implements OnClickListener {
	private String ModuldID = "";
	private String UserName = "testtest";
	private int value_left = 100;
	private int value_right = 100;
	private int value_step = 50;
	
	private RelativeLayout  ll_controller_left;
	
	private CheckBox cb_sensor;
	
	private Button btn_forward;
	private Button btn_backward;
	private Button btn_left;
	private Button btn_right;
	private Button btn_stop;
	private Button btn_speedup;
	private Button btn_speeddown;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        init();
    }
    
    private void init() {
    	ll_controller_left = (RelativeLayout)findViewById(R.id.ll_controller_left);
    	btn_forward = (Button)findViewById(R.id.btn_forward);
    	btn_backward = (Button)findViewById(R.id.btn_backward);
    	btn_left = (Button)findViewById(R.id.btn_left);
    	btn_right = (Button)findViewById(R.id.btn_right);
    	btn_stop = (Button)findViewById(R.id.btn_stop);
    	btn_speedup = (Button)findViewById(R.id.btn_speedup);
    	btn_speeddown = (Button)findViewById(R.id.btn_speeddown);
    	
    	cb_sensor = (CheckBox)findViewById(R.id.cb_sensor);
    	cb_sensor.setOnClickListener(this);
    	
    	btn_forward.setOnClickListener(this);
    	btn_backward.setOnClickListener(this);
    	btn_left.setOnClickListener(this);
    	btn_right.setOnClickListener(this);
    	btn_stop.setOnClickListener(this);
    	btn_speedup.setOnClickListener(this);
    	btn_speeddown.setOnClickListener(this);    	
    }

	@Override
	public void onClick(View v) {
		switch(v.getId()) {
			case R.id.cb_sensor:
				boolean result = cb_sensor.isChecked();
				cb_sensor.setChecked(!result);
				if (result == false) {
					ll_controller_left.setVisibility(View.GONE);
				} else {
					ll_controller_left.setVisibility(View.VISIBLE);
				}
				break;
			case R.id.btn_forward:
				break;
			case R.id.btn_backward:
				break;
			case R.id.btn_left:
				break;
			case R.id.btn_right:
				break;
			case R.id.btn_stop:
				break;
			case R.id.btn_speedup:
				break;
			case R.id.btn_speeddown:
				break;
			default:
				break;
		}
	}
	
	private void sendMsg(String mode, int vleft, int vright) {
		// 0,APPPASSTHROUGH,smli123hz,6044712,15,0,0,BACK2AP,smli123hz,6044712,3_1#
		String command_base = "0,ACTION," + UserName + "," + ModuldID + "," + String.valueOf(vleft) + "," + String.valueOf(vright);
		int command_base_length = command_base.getBytes().length + 1;
		String command = "0,APPPASSTHROUGH," + UserName + "," + ModuldID + "," + String.valueOf(command_base_length) + "," + command_base + "#";
		
		new Thread(sendRunnable).start();
	}
	
	private Runnable sendRunnableBin  = new Runnable() {
	
		@Override
		public void run() {
			AsyncResult ret = new AsyncResult();
	
			InetAddress address = null;
			try {
				if (PubDefine.g_Connect_Mode == PubDefine.SmartPlug_Connect_Mode.Internet) { 
					address = InetAddress.getByName(PubDefine.THINGZDO_HOST_NAME);
				} else {
					address = InetAddress.getByName(mIP);
				}
			} catch (UnknownHostException e) {
				e.printStackTrace();
			}
	
			dSocket = UDPReceiver.getUDPSocket();   //new DatagramSocket(PubDefine.LOCAL_PORT-1); 
			if (dSocket == null) {
				ret.mErrorId = 0;
				ret.mMessage = "create socket fail";
				ret.mStates = AppServerReposeDefine.Socket_Connect_FAIL;
				mHandler.obtainMessage(AppServerReposeDefine.Socket_Connect_FAIL, ret).sendToTarget();	
				return;
			}
	//		// 针对 Shake模式，直接下发到模块，根据模块要求，需要单独增加IP地址和端口号信息；（原因：模块UDP协议无法解析到UDP Socket的IP和Port）
	//		if (PubDefine.g_Connect_Mode == PubDefine.SmartPlug_Connect_Mode.Shake) {
	//			String strLocalIP = PubDefine.global_local_ip == null ? "" : PubDefine.global_local_ip;
	//			String strLocalPort = String.valueOf(dSocket.getLocalPort());
	//			mMessage = mMessage.substring(0, mMessage.indexOf(StringUtils.PACKAGE_END_SYMBOL));
	//			mMessage = mMessage + "," + strLocalIP + "," + strLocalPort + StringUtils.PACKAGE_END_SYMBOL;
	//		}
	
	    	PubFunc.log("SEND_UDP_Bin:" + mMessageBin);
			try {
				DatagramPacket dPacket = new DatagramPacket(mMessageBin, mMessageBin.length, address,
						PubDefine.g_Connect_Mode == PubDefine.SmartPlug_Connect_Mode.Internet ?  
								PubDefine.SERVER_PORT : PubDefine.MODULE_PORT);
	
				dSocket.send(dPacket);
				
				ret.mErrorId = 0;
				ret.mMessage = "OK";
				ret.mStates = AppServerReposeDefine.Socket_Send_OK;
				mHandler.obtainMessage(AppServerReposeDefine.Socket_Send_OK, ret).sendToTarget();
				
			} catch (IOException e) {
				e.printStackTrace();
				ret.mErrorId = 0;
				ret.mMessage = e.toString();
				ret.mStates = AppServerReposeDefine.Socket_Send_Fail;
				mHandler.obtainMessage(AppServerReposeDefine.Socket_Send_Fail, ret).sendToTarget(); 			
			} finally {
				//dSocket.close();
			}
		}
	};	
}
